<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>留言板</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {{
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
        }}
        .message {{
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }}
        .loading {{
            text-align: center;
            color: #666;
            padding: 10px;
        }}
        input, textarea {{
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }}
        button {{
            width: 100%;
            padding: 12px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }}
        button:disabled {{
            background: #b3d7ff;
            cursor: not-allowed;
        }}
        .error {{
            color: #dc3545;
            font-size: 14px;
            margin: 5px 0;
        }}
        @media (max-width: 480px) {{
            body {{ padding: 8px; }}
            .message {{ padding: 10px; }}
        }}
    </style>
</head>
<body>
    <div id="app">
        <!-- 登录模块 -->
        <div v-if="!authenticated">
            <input type="password" 
                   v-model="inputPwd" 
                   @input="inputPwd = inputPwd.trim()"
                   placeholder="请输入访问密码">
            <button @click="login" :disabled="loading">
                {{ loading ? '验证中...' : '进入' }}
            </button>
            <div v-if="error" class="error">{{ error }}</div>
        </div>
 
        <!-- 留言模块 -->
        <div v-if="authenticated">
            <textarea v-model="newMessage" 
                      placeholder="输入留言..." 
                      :disabled="submitting"></textarea>
            <button @click="submitMessage" :disabled="submitting">
                {{ submitting ? '提交中...' : '提交' }}
            </button>
            
            <div v-if="messages.length === 0" class="loading">
                暂无留言，快来第一个发言吧！
            </div>
            
            <div v-for="msg in messages" :key="msg.time" class="message">
                <p>{{ msg.text }}</p>
                <small>{{ formatTime(msg.time) }} - {{ msg.ip }}</small>
            </div>
        </div>
    </div>
 
<script>
const API_KEY = '$2a$10$KeLi9jDm.dt4FvTektpcS..FHwmkTRXTiqNc5cF4yfxXRnsrb0El6';
const BIN_ID = '67f1526d8561e97a50f93799';
const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
 
const app = Vue.createApp({{
    data() {{
        return {{
            authenticated: false,
            inputPwd: '',
            newMessage: '',
            messages: [],
            loading: false,
            error: '',
            submitting: false,
            retryCount: 0 
        }}
    }},
    async mounted() {{
        const savedPwd = localStorage.getItem('savedPwd');
        if(savedPwd) await this.verifyPassword(savedPwd);
    }},
    methods: {{
        async login() {{
            this.loading = true;
            this.error = '';
            try {{
                await this.verifyPassword(this.inputPwd);
                localStorage.setItem('savedPwd', this.inputPwd);
            }} catch (e) {{
                this.error = '验证失败：' + (e.message || '未知错误');
            }} finally {{
                this.loading = false;
            }}
        }},
        
        async verifyPassword(pwd) {{
            try {{
                const response = await fetch(API_URL, {{
                    headers: {{ 'X-Master-Key': API_KEY }}
                }});
                if (!response.ok) throw new Error('API连接失败');
                
                const data = await response.json();
                if (data.record?.password === pwd) {{
                    this.authenticated = true;
                    this.messages = data.record.messages.reverse();
                }} else {{
                    throw new Error('密码错误');
                }}
            }} catch (error) {{
                console.error('验证异常:', error);
                throw error;
            }}
        }},
        
        async submitMessage() {{
            if (!this.newMessage.trim()) return;
            this.submitting = true;
            
            try {{
                // 获取客户端IP 
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const {{ ip }} = await ipRes.json();
                
                // 获取最新数据 
                const fullData = await this.fetchWithRetry(API_URL);
                fullData.record.messages.push({{
                    text: this.newMessage,
                    ip: ip,
                    time: Date.now()
                }});
                
                // 提交更新 
                await this.fetchWithRetry(API_URL, {{
                    method: 'PUT',
                    headers: {{
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY 
                    }},
                    body: JSON.stringify(fullData.record)
                }});
                
                this.messages.unshift(fullData.record.messages.slice(-1)[0]);
                this.newMessage = '';
                this.retryCount = 0;
            }} catch (error) {{
                console.error('提交失败:', error);
                alert(`提交失败${this.retryCount > 0 ? '（已重试）' : ''}，请检查网络`);
            }} finally {{
                this.submitting = false;
            }}
        }},
        
        async fetchWithRetry(url, options) {{
            const maxRetries = 2;
            for (let i = 0; i <= maxRetries; i++) {{
                try {{
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP错误 ${response.status}`);
                    return await response.json();
                }} catch (error) {{
                    if (i === maxRetries) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    this.retryCount++;
                }}
            }}
        }},
        
        formatTime(timestamp) {{
            return new Date(timestamp).toLocaleString('zh-CN', {{
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }});
        }}
    }}
}}).mount('#app');
</script>
</body>
</html>​
